<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>sane-perl-mode - a fork of cperl-mode to fix long-standing bugs</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:ben@mikan.localdomain" />
</head>

<body>



<ul id="index">
  <li><a href="#NAME">NAME</a></li>
  <li><a href="#DESCRIPTION">DESCRIPTION</a></li>
  <li><a href="#CHANGES-FROM-CPERL-MODE">CHANGES FROM CPERL-MODE</a>
    <ul>
      <li><a href="#No-error-messages-each-time-the-m-or-s-key-is-pressed">No error messages each time the m or s key is pressed</a></li>
      <li><a href="#Far-right-indentation">Far-right indentation</a></li>
      <li><a href="#Indent-brace-bug">Indent brace bug</a></li>
      <li><a href="#Indentation-styles">Indentation styles</a></li>
      <li><a href="#Documentation-improvements">Documentation improvements</a></li>
      <li><a href="#Changes-to-defaults">Changes to defaults</a>
        <ul>
          <li><a href="#Underlining-of-trailing-whitespace">Underlining of trailing whitespace</a></li>
          <li><a href="#Untabifying-by-delete-is-off">Untabifying by delete is off</a></li>
          <li><a href="#Font-lock-mode-changes">Font lock mode changes</a></li>
        </ul>
      </li>
      <li><a href="#Removal-of-obsolete-and-non-core-support">Removal of obsolete and non-core support</a>
        <ul>
          <li><a href="#Version-control-systems">Version control systems</a></li>
          <li><a href="#Moose-and-other-non-core-modules">Moose and other non-core modules</a></li>
          <li><a href="#Opinion-comments-removed">Opinion-comments removed</a></li>
          <li><a href="#Removal-of-commented-out-and-obsolete-code">Removal of commented out and obsolete code</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#TESTING">TESTING</a></li>
  <li><a href="#BUGS">BUGS</a></li>
  <li><a href="#PERLTIDY-EQUIVALENTS">PERLTIDY EQUIVALENTS</a></li>
  <li><a href="#SEE-ALSO">SEE ALSO</a>
    <ul>
      <li><a href="#cperl-mode">cperl-mode</a></li>
      <li><a href="#CPAN-modules">CPAN modules</a></li>
      <li><a href="#Other-information">Other information</a></li>
    </ul>
  </li>
  <li><a href="#AUTHORS">AUTHORS</a></li>
</ul>

<h1 id="NAME">NAME</h1>

<p>sane-perl-mode - a fork of cperl-mode to fix long-standing bugs</p>

<h1 id="DESCRIPTION">DESCRIPTION</h1>

<p>This is a fork of the Emacs Perl-editing mode cperl-mode.el. We made this to fix some very long-term problems with cperl-mode.</p>

<p>At the moment we&#39;re documenting using this README.</p>

<h1 id="CHANGES-FROM-CPERL-MODE">CHANGES FROM CPERL-MODE</h1>

<p>This section describes the significant changes to the behaviour of sane-perl-mode compared to cperl-mode. See also <a href="#TESTING">&quot;TESTING&quot;</a> for details of bug fixes.</p>

<h2 id="No-error-messages-each-time-the-m-or-s-key-is-pressed">No error messages each time the m or s key is pressed</h2>

<p>In cperl-mode, Emacs produces an error message about matching parentheses not being found every time the &quot;m&quot; or &quot;s&quot; key is pressed. In sane-perl-mode, these error messages have been eliminated. This is the origin of the word &quot;sane&quot; in the name of this fork.</p>

<p>Whilst labelling cperl-mode and its maintainers as &quot;insane&quot; might be excessive, it&#39;s very difficult to imagine what the people who made Emacs produce an error message each time the keys m or s are pressed were thinking about. With Emacs 27, the screen would scroll when the error messages were produced, so typing &quot;m&quot; or &quot;s&quot; when entering keywords like <code>my</code> or <code>sub</code> would cause the Emacs window to suddenly scroll.</p>

<p>This bug has been reported over and over by many people to the cperl-mode maintainers. BKB pointed the problem out to Ilya Zakharevich on the usenet newsgroup comp.lang.perl.misc in about 2007 or so, so it&#39;s been there for at least fourteen years. However, they have not taken any action.</p>

<p>Anyway the bug is fixed here. We hope it helps you restore your sanity.</p>

<h2 id="Far-right-indentation">Far-right indentation</h2>

<p>Indenting the contents of <code>qw</code> and <code>qr!!x</code> far to the right of the page can now be altered to indent the contents using the normal indentation. To switch off the far-right indentation, set the option <code>sane-perl-indentable-indent</code> to <code>nil</code> in <i>.emacs</i> or its equivalent with</p>

<pre><code>    (setq sane-perl-indentable-indent nil)</code></pre>

<p>Once this option is set, the &quot;far right&quot; indentation</p>

<pre><code>    my @array = qw!
                      far
                      right
                      indentation
                  !;</code></pre>

<p>will be indented as</p>

<pre><code>    my @array = qw!
        normal
        indentation
    !;</code></pre>

<p>Similarly for regular expressions using the <code>/x</code> format.</p>

<p>This fix comes from the <a href="https://github.com/jrockway/cperl-mode/pull/54">jrockway fork of cperl-mode</a>, but it hadn&#39;t been applied in the <a href="#HaraldJoerg">&quot;HaraldJoerg&quot;</a> fork which sane-perl-mode originates from, so it&#39;s been added on here. Further to the jrockway fork fix, sane-perl-mode also puts the indentation of the !; at the end on the left rather than under the final line, as shown above. The jrockway fork currently does the following:</p>

<pre><code>    my @array = qw!
        normal
        indentation
        !;</code></pre>

<h2 id="Indent-brace-bug">Indent brace bug</h2>

<p>The &quot;indent brace bug&quot; happens in cperl-mode when <code>cperl-continued-statement-offset</code> is set to a non-zero value. It causes the opening brace of a subroutine to be indented four spaces:</p>

<pre><code>    sub xyz
        {</code></pre>

<p>instead of</p>

<pre><code>    sub xyz
    {</code></pre>

<p>This is fixed in sane-perl-mode.</p>

<h2 id="Indentation-styles">Indentation styles</h2>

<p>Sane-Perl-Mode provides various indentation styles via the function</p>

<pre><code>    (sane-perl-set-style &quot;BSD&quot;)</code></pre>

<p>and examples of what the indentation styles are supposed to look like. However, at the time we forked the module, the indentation actually produced differed in most of the cases from the examples provided. For example, the example of Whitesmith indentation from the cperl-mode documentation looks like this:</p>

<pre><code>    if (foo)
        {
            bar
                baz;
        label:
            {
                boon;
            }
        }
    else
        {
            stop;
        }</code></pre>

<p>However, the output of <code>cperl-set-style</code> <code>Whitesmith</code> <code>indent-region</code> is as follows:</p>

<pre><code>    if (foo) {
        bar
            baz;
     label:
        {
            boon;
        }
    } else {
        stop;
    }</code></pre>

<p>Because it looks like changes to the defaults of the mode caused this, we are not sure whether to modify the indentation styles or the examples. Generally we have followed the examples and modified the indentation styles to look more like them, but K&amp;R style is given as</p>

<pre><code>     if (foo)
     {
     }
     else
     {</code></pre>

<p>in the cperl-mode documentation, which is definitely wrong, see <a href="https://en.wikipedia.org/wiki/Indentation_style#K&amp;R_style">this Wikipedia article</a>.</p>

<p>The styles where the example did not match the output are <code>BSD</code>, <code>K&amp;R</code>, <code>GNU</code>, and <code>Whitesmith</code>. <code>C++</code>, <code>PBP</code>, and <code>PerlStyle</code>, and the default <code>Sane-Perl</code> were already indenting as per the documentation. We have altered either the settings or the example to bring them into agreement, with the exception of the <code>Whitesmith</code> style, where the documentation and results disagree, on only one line, since we don&#39;t know how to reproduce that indentation using the options.</p>

<h2 id="Documentation-improvements">Documentation improvements</h2>

<p>Spelling and grammar mistakes have been fixed. Some attempt has been made to make the tone of the documentation more professional. Much of the cperl-mode documentation seemed to be designed to deliberately confuse users, or give opinions rather than facts.</p>

<p>We&#39;ve also done some work on the one-line documentation which comes with cperl-mode.</p>

<h2 id="Changes-to-defaults">Changes to defaults</h2>

<p>Some of the default behaviours of cperl-mode have been changed.</p>

<h3 id="Underlining-of-trailing-whitespace">Underlining of trailing whitespace</h3>

<p>The cperl-mode default of using underscores for displaying trailing whitespace has been switched off. Trailing whitespace is harmless in Perl, and hardly merits being highlighted in an exaggerated way, especially since even whitespace in comments was highlighted. Further, the underscores were also misleading. For example, after a dollar the underscore would appear as <code>$_</code> (the default variable) when in fact there was no <code>_</code> there.</p>

<p>cperl-mode requires a setting</p>

<pre><code>    (setq cperl-invalid-face nil)</code></pre>

<p>to stop it from adding underscores to trailing whitespace. This is switched off by default in sane-perl-mode. To restore it, add</p>

<pre><code>    (setq sane-perl-invalid-face &#39;underline)</code></pre>

<p>to <i>.emacs</i>.</p>

<h3 id="Untabifying-by-delete-is-off">Untabifying by delete is off</h3>

<p>Untabifying by delete (turning a tab character into spaces when deleting whitespace) was switched off. It&#39;s still in the mode as a user option.</p>

<h3 id="Font-lock-mode-changes">Font lock mode changes</h3>

<p>Emacs has had font-lock-mode on globally by default since 2007, but in cperl-mode the default for the variable <code>cperl-font-lock</code> is to be turned off.</p>

<p>In the development of sane-perl-mode, we discovered that the default inherited from cperl-mode of having <code>sane-perl-font-lock</code> switched off with Emacs&#39; <code>font-lock-mode</code> on causes some very odd behaviour.</p>

<p>We&#39;ve thus switched it on as the default. It can still be switched off using</p>

<pre><code>    (setq sane-perl-font-lock nil)</code></pre>

<p>In this case, <code>font-lock-mode</code> itself will be switched off for the Perl buffer as well, otherwise the option doesn&#39;t really make sense.</p>

<h2 id="Removal-of-obsolete-and-non-core-support">Removal of obsolete and non-core support</h2>

<h3 id="Version-control-systems">Version control systems</h3>

<p>Support for the CVS, RCS, and SCCS version control systems has been removed.</p>

<h3 id="Moose-and-other-non-core-modules">Moose and other non-core modules</h3>

<p>Support for Moose, Zydeco, and other module-specific keywords has been removed.</p>

<h3 id="Opinion-comments-removed">Opinion-comments removed</h3>

<p>Editorial comments about the future of Perl development and other things have been removed from the mode. Since these are a single person&#39;s opinions, and there have been at least five maintainers of this mode so far, it&#39;s not clear who the opinions belonged to, and it doesn&#39;t make sense to keep them in a mode maintained by other people who may not share the opinions.</p>

<h3 id="Removal-of-commented-out-and-obsolete-code">Removal of commented out and obsolete code</h3>

<p>Commented-out code and clearly obsolete code referring to versions of Emacs from the 1990s have been removed. See also <a href="https://www.nayuki.io/page/dont-share-commented-out-code">Don&rsquo;t share commented-out code</a> by Nayuki.</p>

<h1 id="TESTING">TESTING</h1>

<p>The tests for the mode run Emacs in batch mode and then compare the results to expected outputs using Perl&#39;s <a>Test::More</a> framework. They can be run using the Perl utility <a>prove</a> as</p>

<pre><code>    prove t/*.t</code></pre>

<p>from the top directory.</p>

<p>Currently the following tests exist:</p>

<dl>

<dt id="Non-far-right-indentation">Non far-right indentation</dt>
<dd>

<p>Tests of the <code>qw!!</code> and <code>qr!!x</code> non-far-right indentation have been added in <i>t/run.t</i> and <i>t/test-regex.t</i>. See <a href="#Far-right-indentation">&quot;Far-right indentation&quot;</a>.</p>

</dd>
<dt id="Invert-if">Invert-if</dt>
<dd>

<p>CPerl mode contains a facility to switch between trailing if and leading if, as in</p>

<pre><code>     if (condition) {
         something;
     }</code></pre>

<p>and</p>

<pre><code>     something if condition;</code></pre>

<p>Testing of these in Sane Perl mode, renamed <code>sane-perl-invert-if-unless</code> and <code>sane-perl-invert-if-unless-modifiers</code>, is in <i>t/invert.t</i></p>

</dd>
<dt id="Staircase-indentation">Staircase indentation</dt>
<dd>

<p>The staircase indentation bug is a bug where cperl-mode would indent as follows:</p>

<pre><code>    use constant {
      ONE =&gt; 1,
        TWO =&gt; 2
    };</code></pre>

<p>Testing of the &quot;staircase indentation&quot; bug is in <i>t/staircase.t</i>. The indentation of the cperl-mode we originally forked from seems to be working at the moment.</p>

</dd>
<dt id="Indentation-of-braces">Indentation of braces</dt>
<dd>

<p>The provisional fix of the <a href="#Indent-brace-bug">&quot;Indent brace bug&quot;</a> is tested in <i>t/indent-bug.t</i></p>

</dd>
<dt id="Trailing-whitespace">Trailing whitespace</dt>
<dd>

<p>Underlining of trailing whitespace is no longer the default but it is supported as an option. See <a href="#Underlining-of-trailing-whitespace">&quot;Underlining of trailing whitespace&quot;</a>. Tests of its functioning, if the user chooses to switch it back on, is in <i>t/trailing.t</i>.</p>

</dd>
<dt id="Byte-compilation">Byte compilation</dt>
<dd>

<p>The errors generated by Emacs on byte-compiling cperl-mode.el have all been fixed in sane-perl-mode.el. Tests of this are in <i>t/byte-compile.t</i>.</p>

</dd>
<dt id="Parsing-links-in-Pod">Parsing links in Pod</dt>
<dd>

<p>Cperl mode displays perl documentation using pod2html, but it uses an extra stage before displaying it in a help buffer which changes the links to an Emacs-valid format. There were some problems with parsing nested Pod commands within links. These have been fixed in sane-perl-mode.el. Tests are in <i>t/nested-pod.t</i>.</p>

</dd>
<dt id="Example-indentations">Example indentations</dt>
<dd>

<p>The test <i>t/doc-indent.t</i> tests whether sane-perl-mode produces the same indentation as the example indentations in the document. See <a href="#Indentation-styles">&quot;Indentation styles&quot;</a> for details.</p>

</dd>
<dt id="Semi-colon-bug">Semi-colon bug</dt>
<dd>

<p>A test of our fix of the semicolon bug, where <code>};</code> (for example at the end of a BEGIN block) used to be mistakenly converted into</p>

<pre><code>    }
    ;</code></pre>

<p>on applying <code>indent-region</code> is in <i>t/semicolon-bug.t</i>.</p>

</dd>
<dt id="Tests-of-CPerl-Mode-features">Tests of CPerl-Mode features</dt>
<dd>

<p>We have added some tests of CPerl-Mode features such as its documented indentation options in <i>t/indent.t</i> and <i>t/brace-option.t</i>, as regression tests to make sure that this mode doesn&#39;t start misbehaving in unexpected ways. All of the <code>cperl-mode-</code> options need to use <code>sane-perl-</code> as the prefix but otherwise should work the same way, unless otherwise documented. See <a href="#Changes-to-defaults">&quot;Changes to defaults&quot;</a> for what options have been changed so far.</p>

</dd>
</dl>

<h1 id="BUGS">BUGS</h1>

<p>Please report bugs at <a href="https://github.com/benkasminbullock/sane-perl-mode/issues">the github issue tracker</a>. There is also <a href="https://github.com/benkasminbullock/sane-perl-mode/discussions">a &quot;discussions&quot; option</a> if you&#39;re not sure whether to report a bug or just ask a question.</p>

<h1 id="PERLTIDY-EQUIVALENTS">PERLTIDY EQUIVALENTS</h1>

<p>This section details similar and equivalent commands between the <a>perltidy</a> utility and <code>sane-perl-mode</code>.</p>

<dl>

<dt id="sane-perl-extra-newline-before-brace">sane-perl-extra-newline-before-brace</dt>
<dd>

<p>This option is <code>nil</code> by default. Setting this to <code>t</code> is equivalent to <code>-sbl</code> in perltidy.</p>

</dd>
<dt id="sane-perl-indent-left-aligned-comments">sane-perl-indent-left-aligned-comments</dt>
<dd>

<p>This option is <code>t</code> by default. This corresponds to setting <code>-ibc</code> <code>--indent-block-comments</code> in perltidy. A <code>nil</code> value corresponds to <code>-nibc</code> in perltidy.</p>

</dd>
<dt id="sane-perl-indent-level">sane-perl-indent-level</dt>
<dd>

<p>This option is <code>2</code> by default. This corresponds to <code>-i=2</code> in perltidy. To get the same value as perltidy&#39;s default of 4, use</p>

<pre><code>    (setq sane-perl-indent-level 4)</code></pre>

</dd>
<dt id="sane-perl-merge-trailing-else">sane-perl-merge-trailing-else</dt>
<dd>

<p>This option is <code>t</code> by default. Setting this to <code>t</code> is equivalent to <code>-ce</code> in perltidy.</p>

</dd>
</dl>

<h1 id="SEE-ALSO">SEE ALSO</h1>

<h2 id="cperl-mode">cperl-mode</h2>

<p>Other significant forks of cperl-mode are as follows:</p>

<dl>

<dt id="emacs-mirror">emacs-mirror</dt>
<dd>

<p><a href="https://github.com/emacs-mirror/emacs/blob/master/lisp/progmodes/cperl-mode.el">https://github.com/emacs-mirror/emacs/blob/master/lisp/progmodes/cperl-mode.el</a></p>

<p>The original cperl-mode.el is actively being improved for modern versions of Emacs in the original Emacs trunk.</p>

</dd>
<dt id="HaraldJoerg">HaraldJoerg</dt>
<dd>

<p><a href="https://github.com/HaraldJoerg/cperl-mode">https://github.com/HaraldJoerg/cperl-mode</a></p>

<p>This is a fork of jrockway&#39;s cperl-mode fork. The author also contributes to the original Emacs cperl-mode.el at <a href="#emacs-mirror">&quot;emacs-mirror&quot;</a>.</p>

</dd>
<dt id="jrockway">jrockway</dt>
<dd>

<p><a href="https://github.com/jrockway/cperl-mode">https://github.com/jrockway/cperl-mode</a></p>

<p>This was a fork of Ilya Zakharevich&#39;s cperl-mode which was originally about adding Moose keywords, but then graduated to being some kind of default for a few years as Ilya Z. was not active.</p>

</dd>
</dl>

<h2 id="CPAN-modules">CPAN modules</h2>

<p>(We have assumed that CPAN modules related to Emacs which haven&#39;t had a release for over ten years are defunct and have not included them here.)</p>

<dl>

<dt id="Emacs::PDE"><a>Emacs::PDE</a></dt>
<dd>

<p>This contains Emacs lisp scripts to run <a>perltidy</a> and other facilities.</p>

</dd>
</dl>

<h2 id="Other-information">Other information</h2>

<dl>

<dt id="PerlLanguage-at-EmacsWiki"><a href="https://www.emacswiki.org/emacs/PerlLanguage">PerlLanguage at EmacsWiki</a></dt>
<dd>

</dd>
<dt id="CPerlMode-at-EmacsWiki"><a href="https://www.emacswiki.org/emacs/CPerlMode">CPerlMode at EmacsWiki</a></dt>
<dd>

</dd>
</dl>

<h1 id="AUTHORS">AUTHORS</h1>

<p>Ben Bullock, &lt;benkasminbullock@gmail.com&gt;, &lt;bkb@cpan.org&gt;</p>


</body>

</html>


